name: Update Schedule Data

on:
  # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 6:00 UTC (9:00 ÐœÐ¡Ðš)
  schedule:
    - cron: '0 6 * * *'
  
  # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ (Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  update-schedule:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install beautifulsoup4 requests ics pytz

    - name: Create backup of current data
      run: |
        mkdir -p backup
        cp groups/groups.json backup/groups.json.backup || echo "No groups.json found"
        cp -r rasp backup/rasp.backup || echo "No rasp folder found"

    - name: Run schedule update script
      run: |
        cd /Users/alex/Desktop/rasp/rasp
        python main.py
      env:
        PYTHONUNBUFFERED: 1

    - name: Check for changes
      id: check-changes
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ñ„Ð°Ð¹Ð»Ð°Ñ…
        if git diff --quiet groups/groups.json; then
          echo "groups_changed=false" >> $GITHUB_OUTPUT
        else
          echo "groups_changed=true" >> $GITHUB_OUTPUT
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð¿Ð°Ð¿ÐºÐµ rasp
        if git diff --quiet rasp/; then
          echo "schedule_changed=false" >> $GITHUB_OUTPUT
        else
          echo "schedule_changed=true" >> $GITHUB_OUTPUT
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
        echo "force_update=${{ github.event.inputs.force_update }}" >> $GITHUB_OUTPUT

    - name: Update frontend files
      if: steps.check-changes.outputs.groups_changed == 'true' || steps.check-changes.outputs.schedule_changed == 'true' || steps.check-changes.outputs.force_update == 'true'
      run: |
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² frontend
        cp groups/groups.json frontend/public/groups.json
        mkdir -p frontend/public/rasp
        cp rasp/*.ics frontend/public/rasp/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸
        echo '{"lastUpdated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "version": "'$(date +%s)'"}' > frontend/public/update-info.json

    - name: Configure Git
      if: steps.check-changes.outputs.groups_changed == 'true' || steps.check-changes.outputs.schedule_changed == 'true' || steps.check-changes.outputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Commit and push changes
      if: steps.check-changes.outputs.groups_changed == 'true' || steps.check-changes.outputs.schedule_changed == 'true' || steps.check-changes.outputs.force_update == 'true'
      run: |
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        git add groups/groups.json
        git add rasp/
        git add frontend/public/groups.json
        git add frontend/public/rasp/
        git add frontend/public/update-info.json
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑŒ
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ”„ Auto-update schedule data $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          - Updated groups data
          - Updated schedule files (.ics)
          - Last update: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          Triggered by: ${{ github.event_name }}
          Run ID: ${{ github.run_id }}"
          
          git push
        fi

    - name: Deploy to GitHub Pages
      if: steps.check-changes.outputs.groups_changed == 'true' || steps.check-changes.outputs.schedule_changed == 'true' || steps.check-changes.outputs.force_update == 'true'
      run: |
        cd frontend
        npm ci
        npm run build
        npm run deploy

    - name: Summary
      run: |
        echo "## ðŸ“Š Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Groups changed:** ${{ steps.check-changes.outputs.groups_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "**Schedule changed:** ${{ steps.check-changes.outputs.schedule_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "**Force update:** ${{ steps.check-changes.outputs.force_update }}" >> $GITHUB_STEP_SUMMARY
        echo "**Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Files updated:" >> $GITHUB_STEP_SUMMARY
        echo "- groups/groups.json" >> $GITHUB_STEP_SUMMARY
        echo "- rasp/*.ics files" >> $GITHUB_STEP_SUMMARY
        echo "- frontend/public/groups.json" >> $GITHUB_STEP_SUMMARY
        echo "- frontend/public/rasp/*.ics" >> $GITHUB_STEP_SUMMARY
        echo "- frontend/public/update-info.json" >> $GITHUB_STEP_SUMMARY
